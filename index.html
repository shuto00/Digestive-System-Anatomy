<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>正誤問題クイズ</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 1rem;
      max-width: 600px;
      margin: auto;
    }
    h1, h2 {
      text-align: center;
    }
    button {
      padding: 0.75rem 1.5rem;
      font-size: 1rem;
      margin-top: 1rem;
    }
    .choice {
      display: block;
      margin: 1rem 0;
      padding: 1rem;
      background: #f0f0f0;
      border-radius: 8px;
      font-size: 1.2rem;
      cursor: pointer;
      line-height: 1.5;
    }
    .choice.correct {
      background: #d4edda;
      color: #155724;
    }
    .choice.incorrect {
      background: #f8d7da;
      color: #721c24;
    }
    .explanation {
      background: #fff3cd;
      padding: 1rem;
      border-radius: 8px;
      margin-top: 1rem;
      font-size: 1rem;
      color: #856404;
    }
    .hidden {
      display: none;
    }
    .footer {
      margin-top: 2rem;
      text-align: center;
      font-size: 1rem;
    }
    @media screen and (max-width: 600px) {
      .choice {
        font-size: 1rem;
        padding: 1rem;
      }
    }
  </style>
</head>
<body>

  <h1>正誤問題クイズ</h1>

  <div id="start-screen">
    <h2>モードを選択</h2>
    <label><input type="radio" name="mode" value="challenge" checked> チャレンジモード</label><br>
    <label><input type="radio" name="mode" value="all"> 全問モード</label>

    <div id="question-count-group">
      <label>出題数を選択：</label>
      <select id="question-count">
        <option value="5">5問</option>
        <option value="10">10問</option>
        <option value="20">20問</option>
      </select>
    </div>

    <button onclick="startQuiz()">スタート！</button>
  </div>

  <div id="quiz-screen" class="hidden">
    <h2 id="question-text"></h2>
    <div id="choices"></div>
    <div id="explanation" class="explanation hidden"></div>
    <button id="next-button" class="hidden" onclick="nextQuestion()">次の問題</button>
  </div>

  <div id="result-screen" class="hidden">
    <h2>クイズ終了！</h2>
    <p id="score-text"></p>
    <button onclick="resetQuiz()">もう一度プレイ</button>
  </div>

  <div class="footer">
    <button onclick="resetProgress()">リセット（出題履歴削除）</button>
  </div>

  <script>
    let allQuestions = [];
    let remainingQuestions = [];
    let currentQuestion = null;
    let score = 0;
    let currentIndex = 0;
    let questionLimit = 5;
    let mode = 'challenge';

    fetch('questions.json')
      .then(response => response.json())
      .then(data => {
        allQuestions = data;
      });

    function startQuiz() {
      mode = document.querySelector('input[name="mode"]:checked').value;
      questionLimit = mode === 'all' ? allQuestions.length : parseInt(document.getElementById('question-count').value);
      remainingQuestions = [...allQuestions];
      score = 0;
      currentIndex = 0;
      document.getElementById('start-screen').classList.add('hidden');
      document.getElementById('quiz-screen').classList.remove('hidden');
      nextQuestion();
    }

    function nextQuestion() {
      document.getElementById('explanation').classList.add('hidden');
      document.getElementById('next-button').classList.add('hidden');

      if (currentIndex >= questionLimit || remainingQuestions.length === 0) {
        showResult();
        return;
      }

      const questionSet = drawRandomQuestion();
      currentQuestion = createQuestionPattern(questionSet);
      displayQuestion();
      currentIndex++;
    }

    function drawRandomQuestion() {
      const index = Math.floor(Math.random() * remainingQuestions.length);
      const item = remainingQuestions[index];
      remainingQuestions.splice(index, 1);
      return item;
    }

    function createQuestionPattern(set) {
      const isType1 = Math.random() < 0.5;
      const choices = isType1
        ? [set.correct, set.incorrect, getAnotherIncorrect(set)]
        : [set.incorrect, getAnotherCorrect(set), set.correct];
      return {
        type: isType1 ? 1 : 2,
        correct: set.correct,
        incorrect: set.incorrect,
        choices: shuffleArray(choices)
      };
    }

    function displayQuestion() {
      const qText = currentQuestion.type === 1
        ? '次のうち、正しい文章を選んでください'
        : '次のうち、誤った文章はどれでしょう？';
      document.getElementById('question-text').textContent = qText;

      const choiceContainer = document.getElementById('choices');
      choiceContainer.innerHTML = '';
      currentQuestion.choices.forEach(choice => {
        const btn = document.createElement('div');
        btn.className = 'choice';
        btn.textContent = choice;
        btn.onclick = () => handleAnswer(choice, btn);
        choiceContainer.appendChild(btn);
      });
    }

    function handleAnswer(selected, element) {
      const allChoices = document.querySelectorAll('.choice');
      allChoices.forEach(c => c.onclick = null);

      let isCorrect = false;
      let explanation = '';

      if (currentQuestion.type === 1) {
        isCorrect = selected === currentQuestion.correct;
        if (isCorrect) {
          element.classList.add('correct');
          explanation += currentQuestion.choices
            .filter(c => c !== currentQuestion.correct)
            .map(c => `誤文：「${c}」 → 正しい文：「${getCorrectFromIncorrect(c)}」`).join('<br>');
        } else {
          element.classList.add('incorrect');
          allChoices.forEach(c => {
            if (c.textContent === currentQuestion.correct) c.classList.add('correct');
          });
          explanation += currentQuestion.choices
            .filter(c => c !== currentQuestion.correct)
            .map(c => `誤文：「${c}」 → 正しい文：「${getCorrectFromIncorrect(c)}」`).join('<br>');
        }
      } else {
        isCorrect = selected === currentQuestion.incorrect;
        if (isCorrect) {
          element.classList.add('correct');
          explanation = `誤文：「${selected}」 → 正しい文：「${getCorrectFromIncorrect(selected)}」`;
        } else {
          element.classList.add('incorrect');
          allChoices.forEach(c => {
            if (c.textContent === currentQuestion.incorrect) c.classList.add('correct');
          });
          explanation = `正解はこの誤文：「${currentQuestion.incorrect}」<br>正しい文：「${currentQuestion.correct}」`;
        }
      }

      if (isCorrect) score++;
      document.getElementById('explanation').innerHTML = explanation;
      document.getElementById('explanation').classList.remove('hidden');
      document.getElementById('next-button').classList.remove('hidden');
    }

    function showResult() {
      document.getElementById('quiz-screen').classList.add('hidden');
      document.getElementById('result-screen').classList.remove('hidden');
      const scoreText = `あなたのスコア：${score} / ${questionLimit}`;
      document.getElementById('score-text').textContent = scoreText;

      const bestKey = `bestScore-${mode}-${questionLimit}`;
      const best = Math.max(score, parseInt(localStorage.getItem(bestKey) || '0'));
      localStorage.setItem(bestKey, best);
    }

    function resetQuiz() {
      document.getElementById('result-screen').classList.add('hidden');
      document.getElementById('start-screen').classList.remove('hidden');
    }

    function resetProgress() {
      localStorage.clear();
      alert('ローカル記録をリセットしました');
    }

    function shuffleArray(arr) {
      return arr.sort(() => Math.random() - 0.5);
    }

    function getAnotherIncorrect(set) {
      const pool = allQuestions.filter(q => q !== set);
      return pool[Math.floor(Math.random() * pool.length)].incorrect;
    }

    function getAnotherCorrect(set) {
      const pool = allQuestions.filter(q => q !== set);
      return pool[Math.floor(Math.random() * pool.length)].correct;
    }

    function getCorrectFromIncorrect(incorrectText) {
      const match = allQuestions.find(q => q.incorrect === incorrectText);
      return match ? match.correct : '不明';
    }
  </script>

</body>
</html>
