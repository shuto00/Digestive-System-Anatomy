<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>正誤問題クイズ</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 0;
      padding: 1rem;
      background: #f5f5f5;
      color: #333;
      max-width: 600px;
      margin: auto;
    }

    #title {
      text-align: center;
      font-size: 1.8rem;
      margin-bottom: 1rem;
    }

    .hidden {
      display: none;
    }

    .question-box {
      background: white;
      padding: 1rem;
      border-radius: 1rem;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      margin-bottom: 1rem;
    }

    .choice {
      display: block;
      width: 100%;
      padding: 1rem;
      margin: 0.5rem 0;
      font-size: 1.1rem;
      border: 1px solid #ccc;
      border-radius: 0.5rem;
      background: #fff;
      text-align: left;
      cursor: pointer;
      word-break: break-word;
    }

    .choice:hover {
      background: #eee;
    }

    .choice.selected {
      border: 2px solid #dc3545;
    }

    .choice.correct-answer {
      background: #d4edda;
      color: #155724;
    }

    #next-button, #start-button, #reset-button {
      display: inline-block;
      padding: 0.75rem 1.5rem;
      font-size: 1rem;
      border: none;
      background-color: #007bff;
      color: white;
      border-radius: 0.5rem;
      cursor: pointer;
      margin-top: 1rem;
    }

    #explanation {
      margin-top: 1rem;
      background: #fff3cd;
      padding: 0.75rem;
      border-radius: 0.5rem;
      font-size: 0.95rem;
    }

    #score-display {
      margin-top: 1.5rem;
      font-size: 1.2rem;
      font-weight: bold;
      text-align: center;
    }

    select {
      font-size: 1rem;
      padding: 0.5rem;
      margin-top: 1rem;
    }
  </style>
</head>
<body>
  <div id="title">正誤問題クイズ</div>

  <div id="setup">
    <label>問題数を選んでください:</label><br>
    <select id="question-count">
      <option value="5">5問</option>
      <option value="10">10問</option>
      <option value="15">15問</option>
      <option value="all">全問挑戦</option>
    </select><br>
    <button id="start-button">開始</button>
  </div>

  <div id="quiz-area" class="hidden">
    <div class="question-box">
      <div id="question-text"></div>
      <div id="choices"></div>
      <div id="explanation" class="hidden"></div>
      <button id="next-button" class="hidden">次へ</button>
    </div>
    <div id="score-display" class="hidden"></div>
    <button id="reset-button" class="hidden">リセット</button>
  </div>

  <script>
    let questions = [];
    let remainingQuestions = [];
    let currentQuestion;
    let score = 0;
    let total = 0;

    // 正誤対応データから正解文を取得
    function getCorrectFromIncorrect(incorrect) {
      for (const q of questions) {
        if (q.incorrects.includes(incorrect)) return q.correct;
      }
      return "";
    }

    // 問題データの読み込み
    async function loadData() {
      const res = await fetch("questions.json");
      const data = await res.json();
      questions = data;
    }

    // クイズ開始
    function startQuiz() {
      document.getElementById("title").classList.add("hidden");
      document.getElementById("setup").classList.add("hidden");
      document.getElementById("quiz-area").classList.remove("hidden");

      const count = document.getElementById("question-count").value;
      const shuffled = [...questions].sort(() => Math.random() - 0.5);
      remainingQuestions = (count === "all") ? shuffled : shuffled.slice(0, parseInt(count));
      total = remainingQuestions.length;
      score = 0;
      showNextQuestion();
    }

    // 次の問題を表示
    function showNextQuestion() {
      if (remainingQuestions.length === 0) {
        document.getElementById("question-text").textContent = "終了！";
        document.getElementById("choices").innerHTML = "";
        document.getElementById("explanation").classList.add("hidden");
        document.getElementById("next-button").classList.add("hidden");
        document.getElementById("score-display").textContent = `スコア：${score} / ${total}`;
        document.getElementById("score-display").classList.remove("hidden");
        document.getElementById("reset-button").classList.remove("hidden");
        return;
      }

      document.getElementById("explanation").classList.add("hidden");
      document.getElementById("next-button").classList.add("hidden");

      const q = remainingQuestions.pop();
      currentQuestion = q;

      const choices = [q.correct, ...q.incorrects].sort(() => Math.random() - 0.5);
      const type = Math.random() < 0.5 ? 1 : 2;
      currentQuestion.choices = choices;
      currentQuestion.type = type;

      document.getElementById("question-text").textContent =
        type === 1 ? "次のうち、正しい文章を選んでください。" : "次のうち、誤った文章はどれでしょう？";

      const container = document.getElementById("choices");
      container.innerHTML = "";
      choices.forEach(choice => {
        const btn = document.createElement("button");
        btn.textContent = choice;
        btn.className = "choice";
        btn.onclick = () => handleAnswer(choice, btn);
        container.appendChild(btn);
      });
    }

    // 回答処理
    function handleAnswer(selected, element) {
      const allChoices = document.querySelectorAll(".choice");
      allChoices.forEach(c => c.onclick = null); // 回答ロック

      element.classList.add("selected"); // 赤枠

      let isCorrect = false;
      let explanation = "";

      if (currentQuestion.type === 1) {
        isCorrect = selected === currentQuestion.correct;

        allChoices.forEach(c => {
          if (c.textContent === currentQuestion.correct) {
            c.classList.add("correct-answer");
          }
        });

        explanation = currentQuestion.incorrects
          .map(w => `正しい文：「${getCorrectFromIncorrect(w)}」`)
          .join("<br>");

      } else {
        isCorrect = currentQuestion.incorrects.includes(selected);

        allChoices.forEach(c => {
          if (currentQuestion.incorrects.includes(c.textContent)) {
            c.classList.add("correct-answer");
          }
        });

        explanation = `正しい文：「${getCorrectFromIncorrect(selected)}」`;
      }

      if (isCorrect) score++;
      document.getElementById("explanation").innerHTML = explanation;
      document.getElementById("explanation").classList.remove("hidden");
      document.getElementById("next-button").classList.remove("hidden");
    }

    document.getElementById("start-button").onclick = startQuiz;
    document.getElementById("next-button").onclick = showNextQuestion;
    document.getElementById("reset-button").onclick = () => location.reload();

    loadData();
  </script>
</body>
</html>
